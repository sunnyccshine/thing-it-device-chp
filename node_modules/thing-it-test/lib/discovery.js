module.exports = {
    create: function (node, autoDiscoveryDeviceType) {
        var deviceType = node.plugins[autoDiscoveryDeviceType.plugin];
        var module = require(deviceType.modulePath);
        var discovery = module.discovery(autoDiscoveryDeviceType.options);

        discovery.deviceTypePlugin = autoDiscoveryDeviceType.plugin;
        discovery.confirmRegistration = autoDiscoveryDeviceType.confirmRegistration;
        discovery.persistRegistration = autoDiscoveryDeviceType.persistRegistration;
        discovery.deviceType = deviceType;
        discovery.logLevel = discovery.logLevel ? discovery.logLevel : node.logLevel;

        utils.inheritMethods(discovery, new Discovery());

        if (autoDiscoveryDeviceType.defaultConfiguration) {
            discovery.defaultConfiguration = autoDiscoveryDeviceType.defaultConfiguration;
        }
        else {
            discovery.defaultConfiguration = {};
        }

        discovery.node = node;

        return discovery;
    }
};

var utils = require("./utils");
var device = require("./device");
var logger = require("./logger");

/**
 *
 * @constructor
 */
function Discovery() {
    this.class = "Discovery";

    utils.inheritMethods(this, logger.create());

    /**
     *
     */
    Discovery.prototype.advertiseDevice = function (newDevice) {
        for (var n in this.node.devices) {
            if (newDevice.uuid === this.node.devices[n].uuid &&
                this.deviceTypePlugin === this.node.devices[n].plugin) {

                this.logInfo("\tRejecting discovered Device " + newDevice.uuid + " (" + this.deviceTypePlugin + ") as it is already registered/configured.");

                return;
            }
        }

        this.logInfo("Advertise availability of device");

        // TODO Control centralized this functionality

        utils.inheritMethods(newDevice, device.create());

        newDevice.node = this.node;
        newDevice.__type = this.deviceType;
        newDevice.plugin = this.deviceTypePlugin;

        var index = utils.getNextIdIndex(this.node.devices, this.deviceType.id, 1);

        newDevice.id = this.deviceType.plugin + index;
        newDevice.label = this.deviceType.label + " " + index;


        if (this.confirmRegistration) {
            this.node.pendingDeviceRegistrations[newDevice.uuid] = newDevice;

            this.logInfo("\tAdvertising Device [" + newDevice.label + "].");

            this.node.publishDeviceAdvertisement(newDevice);
        }
        else {
            this.node.devices.push(newDevice);

            if (this.persistRegistration) {
                this.logInfo("Persist Device Registration for Device [" + newDevice.label + "].");
            }
            else {
                newDevice.start().then(function () {
                    this.node.publishDeviceRegistration(newDevice);
                }.bind(this)).fail(function (error) {
                }.bind(this));
            }
        }
    };
}